name: Compress JPG/PNG to WEBP and Deploy
on:
  push:
    branches:
      - main
permissions:
  contents: write
jobs:
  compress_upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set up ImageMagick
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick librsvg2-bin
      - name: Compress JPG/PNG/SVG to WEBP
        run: |
          mkdir -p webp
          shopt -s nullglob
          for img in *.jpg *.jpeg *.png *.svg; do
            if [ -f "$img" ]; then
              filetype=$(file --brief --mime-type "$img")
              if [[ "$filetype" == "image/jpeg" || "$filetype" == "image/png" ]]; then
                convert "$img" -resize 800x -quality 80 "webp/${img%.*}.webp"
              elif [[ "$filetype" == "image/svg+xml" ]]; then
                # Convert SVG to PNG first, then to WEBP for better control
                tmp_png="tmp_${img%.*}.png"
                rsvg-convert -w 800 -o "$tmp_png" "$img"
                convert "$tmp_png" -quality 80 "webp/${img%.*}.webp"
                rm "$tmp_png"
              else
                echo "Skipping unsupported file type: $img ($filetype)"
              fi
            fi
          done
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./webp
          publish_branch: gh-pages
